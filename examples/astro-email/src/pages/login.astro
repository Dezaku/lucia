---
import { auth } from "@auth/lucia";
import { LuciaError } from "lucia";

import MainLayout from "src/layouts/MainLayout.astro";

let errorMessage: string | null = null;
let email = "";

const handleFormSubmission = async (): Promise<Response | null> => {
	if (!Astro.locals.isValidFormSubmission()) return null;
	const formData = await Astro.request.formData();
	email = formData.get("email")?.toString() ?? "";
	if (email === null || !email.includes("@")) {
		errorMessage = "Incorrect email or password";
		return null;
	}
	const password = formData.get("password");
	if (password instanceof File || password === null) {
		errorMessage = "Incorrect email or password";
		return null;
	}
	try {
		const key = await auth.useKey("email", email, password);
		const session = await auth.createSession(key.userId);
		Astro.locals.auth.setSession(session);
		return Astro.redirect("/", 302);
	} catch (e) {
		if (e instanceof LuciaError && e.message === "AUTH_INVALID_KEY_ID") {
			errorMessage = "Incorrect email or password";
			return null;
		}
		if (e instanceof LuciaError && e.message === "AUTH_INVALID_PASSWORD") {
			errorMessage = "Incorrect email or password";
			return null;
		}
		errorMessage = "An unknown error occurred";
		return null;
	}
};

const formSubmissionResponse = await handleFormSubmission();
if (formSubmissionResponse) return formSubmissionResponse;

const session = await Astro.locals.auth.validate();
if (session) {
	if (!session.user.emailVerified) {
		return Astro.redirect("/email-verification", 302);
	}
	return Astro.redirect("/", 302);
}
---


<MainLayout>
	<h2>Sign in</h2>
	<form method="post">
		<label for="email">Email</label><br />
		<input
			id="email"
			name="email"
			value={email?.toString() ?? ""}
		/><br />
		<label for="password">password</label><br />
		<input
			type="password"
			id="password"
			name="password"
		/><br />
		<input type="submit" value="Continue" class="button" />
	</form>
	{errorMessage && <p class="error">{errorMessage}</p>}
	<a href="/signup" class="link">Create an account</a>
	<a href="/password-reset" class="link">Forgot password?</a>
</MainLayout>
